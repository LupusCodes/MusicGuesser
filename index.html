<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify QR Scanner + PDF Generator (12-Card Grid)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>
  <button id="generate-pdf">Generate PDF from Playlist</button>
  <canvas id="text-canvas" style="display:none;"></canvas>

  <script>
    const { jsPDF } = window.jspdf;
    const generatePdfBtn = document.getElementById("generate-pdf");

    async function generatePDFfromPlaylist() {
      const tracks = [
        // Replace with real data from Spotify API
        {
          external_url: "https://open.spotify.com/track/example1",
          name: "Song One",
          artists: "Artist A",
          album: "Album A",
          release_date: "2021-01-01"
        },
        // Repeat up to 12+ tracks
      ];

      const doc = new jsPDF({ unit: "pt", format: "a4", orientation: "portrait" });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const margin = 40;
      const cols = 3;
      const rows = 4;
      const cellWidth = (pageWidth - 2 * margin) / cols;
      const cellHeight = (pageHeight - 2 * margin) / rows;
      const fontSize = 12;
      const lineHeight = fontSize * 1.2;

      const canvas = document.getElementById("text-canvas");
      canvas.width = Math.ceil(cellWidth);
      canvas.height = Math.ceil(cellHeight);
      const ctx = canvas.getContext("2d");

      function wrapText(text, maxWidth) {
        ctx.font = `${fontSize}pt Arial`;
        const words = text.split(" ");
        const lines = [];
        let line = "";
        for (let word of words) {
          const testLine = line + word + " ";
          if (ctx.measureText(testLine).width < maxWidth) {
            line = testLine;
          } else {
            lines.push(line.trim());
            line = word + " ";
          }
        }
        if (line) lines.push(line.trim());
        return lines;
      }

      for (let i = 0; i < tracks.length; i += 12) {
        const group = tracks.slice(i, i + 12);

        // QR code page
        group.forEach((track, idx) => {
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x = margin + col * cellWidth;
          const y = margin + row * cellHeight;

          const qr = new QRious({ value: track.external_url, size: Math.floor(cellWidth * 0.8) });
          doc.addImage(
            qr.toDataURL("image/png"),
            "PNG",
            x + cellWidth * 0.1,
            y + cellHeight * 0.1,
            cellWidth * 0.8,
            cellHeight * 0.8
          );
        });
        doc.addPage();

        // Info page (mirrored)
        for (let idx = 0; idx < group.length; idx++) {
          const track = group[idx];
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x0 = margin + col * cellWidth;
          const y0 = margin + row * cellHeight;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const lines = [];
          lines.push(...wrapText("ðŸŽµ " + track.name, cellWidth - 16));
          lines.push(...wrapText("ðŸ‘¤ " + track.artists, cellWidth - 16));
          lines.push(...wrapText("ðŸ’¿ " + track.album, cellWidth - 16));
          const year = track.release_date.split("-")[0];
          lines.push(...wrapText("ðŸ“… " + year, cellWidth - 16));

          const totalHeight = lines.length * lineHeight;
          const startY = (canvas.height - totalHeight) / 2;

          lines.forEach((line, i) => {
            ctx.font = line.startsWith("ðŸ“…") ? `${fontSize + 2}pt Arial` : `${fontSize}pt Arial`;
            ctx.fillStyle = "#000";
            ctx.textAlign = "center";
            ctx.fillText(line, canvas.width / 2, startY + i * lineHeight);
          });

          const img = new Image();
          img.src = canvas.toDataURL("image/png");
          await new Promise((res) => {
            img.onload = () => {
              const mirrorCanvas = document.createElement("canvas");
              mirrorCanvas.width = canvas.width;
              mirrorCanvas.height = canvas.height;
              const mCtx = mirrorCanvas.getContext("2d");
              mCtx.translate(mirrorCanvas.width, 0);
              mCtx.scale(-1, 1);
              mCtx.drawImage(img, 0, 0);
              const mirroredData = mirrorCanvas.toDataURL("image/png");
              doc.addImage(mirroredData, "PNG", x0, y0, cellWidth, cellHeight);
              res();
            };
          });
        }

        if (i + 12 < tracks.length) doc.addPage();
      }

      doc.save("playlist-12-grid.pdf");
    }

    generatePdfBtn.addEventListener("click", generatePDFfromPlaylist);
  </script>
</body>
</html>
