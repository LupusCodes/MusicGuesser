<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify QR Scanner + PDF Generator w/ Emojis</title>

  <!-- html5-qrcode & Spotify SDK (if used elsewhere) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <!-- jsPDF for PDF creation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- QRious for client-side QR code generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #121212, #1DB954);
      color: white;
      overflow: hidden;
      text-align: center;
      touch-action: manipulation;
    }
    .screen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
    }
    #login-screen {
      display: flex;
    }
    #reader {
      width: 80vw;
      height: 80vw;
      max-width: 400px;
      max-height: 400px;
      margin: 20px auto;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      aspect-ratio: 1/1;
      overflow: hidden;
    }
    .spotify-button {
      background-color: #1DB954;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      margin: 20px 0;
      transition: background-color 0.3s;
    }
    .spotify-button:hover {
      background-color: #16a349;
    }
    .secondary-button {
      background-color: #535353;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .secondary-button:hover {
      background-color: #6e6e6e;
    }
    .app-title {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .input-container {
      margin-bottom: 15px;
      width: 100%;
      max-width: 400px;
    }
    .spotify-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: white;
      font-size: 16px;
      margin-top: 5px;
    }
    /* etc‚Ä¶ (keep your existing styles for the other screens) */
  </style>
</head>
<body>
  <!-- ===== LOGIN SCREEN ===== -->
  <div id="login-screen" class="screen">
    <h2 class="app-title">Spotify QR Scanner</h2>
    <p>Click below to connect your Spotify account</p>
    <button id="spotify-login" class="spotify-button">Connect Spotify</button>
    <p id="error-message" style="color: red;"></p>
    <!-- Generate PDF button on the login screen -->
    <button id="generate-pdf-login" class="secondary-button">Generate PDF from Playlist</button>
  </div>

  <!-- ===== SCANNER SCREEN ===== -->
  <div id="scanner-screen" class="screen">
    <!-- (your scanner UI‚Ä¶) -->
    <button id="generate-pdf-scanner" class="secondary-button" style="margin-top: 10px;">
      Generate PDF from Playlist
    </button>
  </div>

  <!-- ===== PLAYLIST INPUT SCREEN ===== -->
  <div id="playlist-input-screen" class="screen">
    <h2 class="app-title">Playlist Mode</h2>
    <div class="input-container">
      <label for="playlist-url">Spotify Playlist URL:</label>
      <input type="text" id="playlist-url" class="spotify-input" placeholder="https://open.spotify.com/playlist/..." />
    </div>
    <div class="input-container">
      <label for="player-count">Number of Players:</label>
      <input type="number" id="player-count" class="spotify-input" min="1" max="10" value="2" />
    </div>
    <button id="start-playlist-game" class="spotify-button">Start Game</button>
    <button id="return-to-scanner-from-playlist" class="secondary-button">Back to Scanner</button>
  </div>

  <!-- ===== PLAYER SCREEN ===== -->
  <div id="player-screen" class="screen">
    <!-- (your player UI‚Ä¶) -->
  </div>

  <!-- ===== HIDDEN CANVAS (used only for drawing metadata cells) ===== -->
  <canvas id="text-canvas" style="display:none;"></canvas>

  <script>
    // ===== SPOTIFY SDK / LOGIN / SCANNING LOGIC (unchanged except for new buttons) =====
    const CLIENT_ID = '1325a171deaa4a0d91bf676e43c8485c';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = [
      'user-read-playback-state',
      'user-modify-playback-state',
      'user-read-currently-playing',
      'streaming',
      'playlist-read-private'
    ].join(' ');

    // Screen elements
    const loginScreen = document.getElementById('login-screen');
    const scannerScreen = document.getElementById('scanner-screen');
    const playerScreen = document.getElementById('player-screen');
    const playlistInputScreen = document.getElementById('playlist-input-screen');
    const spotifyLoginBtn = document.getElementById('spotify-login');
    const readerElement = document.getElementById('reader');
    const statusElement = document.getElementById('status');
    const playlistUrlInput = document.getElementById('playlist-url');
    const playerCountInput = document.getElementById('player-count');
    const startPlaylistGameBtn = document.getElementById('start-playlist-game');
    const returnToScannerFromPlaylistBtn = document.getElementById('return-to-scanner-from-playlist');
    const switchToPlaylistBtn = document.getElementById('switch-to-playlist');
    const generatePdfLoginBtn = document.getElementById('generate-pdf-login');
    const generatePdfScannerBtn = document.getElementById('generate-pdf-scanner');

    let accessToken = null;
    let html5QrCode = null;
    let spotifyPlayer = null;
    let deviceId = null;
    let playerReady = false;
    let scannerInitialized = false;
    let scannerStopping = false;
    let playlistTracks = [];
    let playedTrackIndices = [];
    let currentPlaylistIndex = null;
    let playerCount = 2;
    let players = [];
    let currentTrackYear = null;
    let isPlaylistMode = false;

    window.onSpotifyWebPlaybackSDKReady = () => {
      if (!accessToken) return;
      initializeSpotifyPlayer();
    };

    function initializeSpotifyPlayer() {
      spotifyPlayer = new Spotify.Player({
        name: 'Spotify QR Scanner',
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.5
      });

      spotifyPlayer.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        playerReady = true;
      });

      spotifyPlayer.connect().catch(console.error);
    }

    function switchToScreen(screenElement) {
      [loginScreen, scannerScreen, playerScreen, playlistInputScreen].forEach(s => {
        s.style.display = 'none';
      });
      screenElement.style.display = 'flex';
    }

    function initiateSpotifyLogin() {
      const authUrl = new URL('https://accounts.spotify.com/authorize');
      authUrl.searchParams.set('client_id', CLIENT_ID);
      authUrl.searchParams.set('response_type', 'token');
      authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
      authUrl.searchParams.set('scope', SCOPES);
      authUrl.searchParams.set('show_dialog', 'true');
      window.location.href = authUrl.toString();
    }

    function getPlaylistIdFromUrl(url) {
      const regex = /(?:spotify:playlist:|https?:\/\/open\.spotify\.com\/playlist\/)([a-zA-Z0-9]+)/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    async function fetchPlaylistTracks(playlistId) {
      const allTracks = [];
      let offset = 0;
      let hasMore = true;
      while (hasMore) {
        const resp = await fetch(
          `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100&offset=${offset}`,
          { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        if (!resp.ok) throw new Error(`Spotify API error ${resp.status}`);
        const data = await resp.json();
        const items = data.items.filter(item => item.track && !item.track.is_local);
        items.forEach(item => {
          const t = item.track;
          allTracks.push({
            id: t.id,
            external_url: t.external_urls.spotify,
            name: t.name,
            artists: t.artists.map(a => a.name).join(', '),
            album: t.album.name,
            release_date: t.album.release_date
          });
        });
        offset += items.length;
        hasMore = data.next !== null && items.length > 0;
      }
      return allTracks;
    }

    // ====== PDF‚ÄêGENERATION LOGIC (using jsPDF + Canvas for emojis) ======
    async function generatePDFfromPlaylist() {
      if (!accessToken) {
        alert('Please log in to Spotify first.');
        return;
      }

      const playlistUrl = prompt('Enter a Spotify Playlist URL:');
      if (!playlistUrl) return;

      const playlistId = getPlaylistIdFromUrl(playlistUrl.trim());
      if (!playlistId) {
        alert('Invalid Spotify playlist URL.');
        return;
      }

      // temporarily disable the button
      const loaderBtn = document.activeElement;
      loaderBtn.textContent = 'Loading‚Ä¶';
      loaderBtn.disabled = true;

      let tracks;
      try {
        tracks = await fetchPlaylistTracks(playlistId);
      } catch (err) {
        console.error(err);
        alert('Could not fetch tracks.');
        loaderBtn.textContent = 'Generate PDF from Playlist';
        loaderBtn.disabled = false;
        return;
      }
      if (!tracks.length) {
        alert('Playlist is empty or private.');
        loaderBtn.textContent = 'Generate PDF from Playlist';
        loaderBtn.disabled = false;
        return;
      }

      // Initialize jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
      const pageWidth = doc.internal.pageSize.getWidth();   // ~595.28
      const pageHeight = doc.internal.pageSize.getHeight(); // ~841.89
      const margin = 40;            // 40pt margin all around
      const cols = 2;
      const rows = 3;
      const cellWidth = (pageWidth - 2 * margin) / cols;
      const cellHeight = (pageHeight - 2 * margin) / rows;
      const fontSize = 12;          // 12pt font
      const lineHeight = fontSize * 1.2;

      // Offscreen canvas to draw text (with emojis)
      const canvas = document.getElementById('text-canvas');
      // Round up to avoid sub‚Äêpixel issues
      canvas.width = Math.ceil(cellWidth);
      canvas.height = Math.ceil(cellHeight);
      const ctx = canvas.getContext('2d');

      // Helper: wrap text to fit within maxWidth (in points)
      function wrapTextForCanvas(text, maxWidthPt) {
        const words = text.split(' ');
        const lines = [];
        let current = '';
        ctx.font = `${fontSize}pt Arial`; // browser font with emoji support
        for (let w of words) {
          const test = current ? (current + ' ' + w) : w;
          const testWidthPx = ctx.measureText(test).width;
          // ctx.measureText returns pixels; 1 pt ‚âà 1.3333px in many canvases,
          // but since we're matching canvas‚Äêpx to PDF‚Äêpt 1:1 (we set canvas.width=cellWidth in px),
          // we can just compare pixel widths directly to cellWidth‚Äê16.
          if (testWidthPx <= (maxWidthPt)) {
            current = test;
          } else {
            if (current) lines.push(current);
            current = w;
          }
        }
        if (current) lines.push(current);
        return lines;
      }

      // Loop over each group of 6 tracks
      for (let i = 0; i < tracks.length; i += 6) {
        const group = tracks.slice(i, i + 6);

        // ‚Äî‚Äî‚Äî 1) QR Code Page ‚Äî‚Äî‚Äî
        for (let idx = 0; idx < group.length; idx++) {
          const track = group[idx];
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x0 = margin + col * cellWidth;
          const y0 = margin + row * cellHeight;
          const centerX = x0 + cellWidth / 2;
          const centerY = y0 + cellHeight / 2;
          const imgSize = Math.min(cellWidth, cellHeight) * 0.8;

          const qr = new QRious({
            value: track.external_url,
            size: Math.floor(imgSize)
          });
          const qrDataUrl = qr.toDataURL('image/png');

          doc.addImage(
            qrDataUrl,
            'PNG',
            centerX - imgSize / 2,
            centerY - imgSize / 2,
            imgSize,
            imgSize
          );
        }
        doc.addPage();

        // ‚Äî‚Äî‚Äî 2) Metadata Page (draw each ‚Öô‚Äêcell as a canvas image) ‚Äî‚Äî‚Äî
        for (let idx = 0; idx < group.length; idx++) {
          const track = group[idx];
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x0 = margin + col * cellWidth;
          const y0 = margin + row * cellHeight;

          // Clear the canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Draw a transparent background so that only text is visible
          // (Alternatively, fill white if you want a white box: ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);)

          // Prepare lines (with emojis in the labels)
          const labelSong   = 'üéµ ';
          const labelArtist = 'üë§ ';
          const labelAlbum  = 'üíø ';
          const labelYear   = 'üìÖ ';
          const maxTextWidth = cellWidth - 16; // 8pt padding each side

          ctx.fillStyle = "#000000";               // black text
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          ctx.font = `${fontSize}pt Arial`;

          // Wrap each line individually
          let lines = [];
          lines.push(...wrapTextForCanvas(labelSong   + track.name,   maxTextWidth));
          lines.push(...wrapTextForCanvas(labelArtist + track.artists, maxTextWidth));
          lines.push(...wrapTextForCanvas(labelAlbum  + track.album,   maxTextWidth));
          const year = track.release_date ? track.release_date.split('-')[0] : 'N/A';
          lines.push(...wrapTextForCanvas(labelYear  + year,           maxTextWidth));

          // Compute total text height (in px) = lines.length * (lineHeightPx),
          // where lineHeightPx ‚âà (lineHeight * devicePixelRatio)? Simplify by using lineHeight as pt ~ px
          const totalTextHeight = lines.length * (lineHeight);
          // Start Y so that text block is vertically centered in the cell
          let startY = (canvas.height - totalTextHeight) / 2;

          // Draw each line on canvas
          for (let j = 0; j < lines.length; j++) {
            // x = canvas.width/2, y = startY + j * lineHeight
            ctx.fillText(lines[j], canvas.width / 2, startY + j * lineHeight);
          }

          // Now convert the canvas to a PNG data URL
          const imgDataUrl = canvas.toDataURL('image/png');

          // Add that image to the PDF at exactly cellWidth √ó cellHeight
          doc.addImage(
            imgDataUrl,
            'PNG',
            x0,
            y0,
            cellWidth,
            cellHeight
          );
        }

        // If more tracks remain, add a new page
        if (i + 6 < tracks.length) {
          doc.addPage();
        }
      }

      // Finally, trigger the download
      doc.save('playlist.pdf');

      loaderBtn.textContent = 'Generate PDF from Playlist';
      loaderBtn.disabled = false;
    }

    // Attach ‚ÄúGenerate PDF‚Äù listeners
    generatePdfLoginBtn.addEventListener('click', generatePDFfromPlaylist);
    generatePdfScannerBtn.addEventListener('click', generatePDFfromPlaylist);

    // ‚Ä¶the rest of your original JS (QR‚Äêscanner, player, etc.) remains unchanged‚Ä¶
    // You only needed to replace the metadata‚Äêrendering part with the canvas‚Äêbased approach above.

    function init() {
      const hash = window.location.hash.substring(1).split('&').reduce((acc, item) => {
        if (!item) return acc;
        const [k, v] = item.split('=');
        acc[k] = decodeURIComponent(v);
        return acc;
      }, {});
      if (hash.access_token) {
        accessToken = hash.access_token;
        window.location.hash = '';
        if (window.Spotify) initializeSpotifyPlayer();
        // startQRScanner(); // or whichever screen to show next
        switchToScreen(scannerScreen);
      } else {
        switchToScreen(loginScreen);
      }
    }

    spotifyLoginBtn.addEventListener('click', initiateSpotifyLogin);
    window.addEventListener('beforeunload', () => {
      // clean up if needed
    });

    init();
  </script>
</body>
</html>
