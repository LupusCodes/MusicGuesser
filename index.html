<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify QR Scanner</title>
  <!-- Load QR Code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
  <!-- Load Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #121212, #1DB954);
      color: white;
      overflow: hidden;
      text-align: center;
      touch-action: manipulation;
    }
    .screen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
    }
    /* Login, scanner & player screens */
    #login-screen { display: flex; }
    #reader {
      width: 80vw;
      height: 80vw;
      max-width: 400px;
      max-height: 400px;
      margin: 20px auto;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      aspect-ratio: 1/1;
      overflow: hidden;
    }
    .spotify-button {
      background-color: #1DB954;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      margin: 20px 0;
      transition: background-color 0.3s;
    }
    .spotify-button:hover { background-color: #16a349; }
    .secondary-button {
      background-color: #535353;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .secondary-button:hover { background-color: #6e6e6e; }
    .player-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }
    .player-button {
      background-color: #1DB954;
      color: white;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 20px;
      transition: transform 0.2s, background-color 0.3s;
    }
    .player-button:hover {
      background-color: #16a349;
      transform: scale(1.05);
    }
    .scanner-status { margin-bottom: 15px; font-weight: bold; }
    .playback-status { font-size: 18px; margin-bottom: 20px; }
    .app-title { font-size: 24px; margin-bottom: 10px; }

    /* Playlist Mode screen styles */
    #playlist-input-screen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
    }
    .input-container {
      margin-bottom: 15px;
      width: 100%;
      max-width: 400px;
    }
    .spotify-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: white;
      font-size: 16px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="screen">
    <h2 class="app-title">Spotify QR Scanner</h2>
    <p>Click below to connect your Spotify account</p>
    <button id="spotify-login" class="spotify-button">Connect Spotify</button>
    <p id="error-message" style="color: red;"></p>
  </div>

  <!-- Scanner Screen (for QR code scanning) -->
  <div id="scanner-screen" class="screen">
    <select id="game-mode" class="spotify-input" style="max-width: 200px;">
      <option value="full">Full Song</option>
      <option value="random10">Random 10 Seconds</option>
      <option value="progressive">Progressive Mode</option>
    </select>
    <div id="status" class="scanner-status">Scan a Spotify QR Code</div>
    <div id="reader"></div>
    <button id="switch-to-playlist" class="secondary-button" style="margin-top: 20px;">Use Playlist Mode</button>
  </div>

  <!-- Playlist Input Screen -->
  <div id="playlist-input-screen" class="screen">
    <h2 class="app-title">Playlist Mode</h2>
    <div class="input-container">
      <label for="playlist-url">Spotify Playlist URL:</label>
      <input type="text" id="playlist-url" class="spotify-input" placeholder="https://open.spotify.com/playlist/..." />
    </div>
    <button id="start-playlist" class="spotify-button">Start Playlist</button>
    <button id="back-to-scanner" class="secondary-button">Back to Scanner</button>
  </div>

  <!-- Player Screen -->
  <div id="player-screen" class="screen">
    <div id="current-track-info">Ready to play...</div>
    <div class="playback-status">Now Playing</div>
    <div class="player-controls">
      <button id="play-pause" class="player-button">▶️</button>
      <button id="seek-forward" class="player-button">⏩</button>
      <button id="increase-duration" class="player-button" style="display: none;">+</button>
    </div>
    <div id="snippet-duration" style="margin-top: 10px; font-size: 16px; display: none;"></div>
    <button id="return-to-scanner" class="secondary-button">Scan New Song</button>
  </div>

  <script>
    // IMPORTANT: Replace with YOUR Spotify Client ID
    const CLIENT_ID = '1325a171deaa4a0d91bf676e43c8485c';
    // Must match your Spotify Developer Dashboard settings
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = [
      'user-read-playback-state',
      'user-modify-playback-state',
      'user-read-currently-playing',
      'streaming'
    ].join(' ');

    // Global variables for both modes
    let accessToken = null;
    let html5QrCode = null;
    let currentTrackUri = null;
    let currentTrackName = '';
    let spotifyPlayer = null;
    let deviceId = null;
    let isPlaying = false;
    let randomSegmentStart = 0;
    let randomSegmentEnd = 0;
    let trackDuration = 0;
    let positionCheckInterval = null;
    let playerReady = false;
    let scannerInitialized = false;
    let gameModeSwitched = false;
    let scannerStopping = false;
    let progressiveDurations = [1000,2000,5000,10000,20000,30000,60000];
    let currentDurationIndex = 0;

    // Variables for playlist mode
    let playlistTracks = [];
    let isPlaylistMode = false;

    // Screen elements
    const loginScreen = document.getElementById('login-screen');
    const scannerScreen = document.getElementById('scanner-screen');
    const playlistInputScreen = document.getElementById('playlist-input-screen');
    const playerScreen = document.getElementById('player-screen');
    const spotifyLoginBtn = document.getElementById('spotify-login');
    const readerElement = document.getElementById('reader');
    const statusElement = document.getElementById('status');
    const gameModeSelect = document.getElementById('game-mode');
    const trackInfoElement = document.getElementById('current-track-info');
    const returnToScannerBtn = document.getElementById('return-to-scanner');
    const increaseDurationBtn = document.getElementById('increase-duration');
    const snippetDurationElement = document.getElementById('snippet-duration');

    // Playlist screen elements
    const switchToPlaylistBtn = document.getElementById('switch-to-playlist');
    const backToScannerBtn = document.getElementById('back-to-scanner');
    const startPlaylistBtn = document.getElementById('start-playlist');
    const playlistUrlInput = document.getElementById('playlist-url');

    // Player control buttons
    const playPauseBtn = document.getElementById('play-pause');
    const seekForwardBtn = document.getElementById('seek-forward');

    // Spotify SDK callback – using the same as your pre‑playlist file
    window.onSpotifyWebPlaybackSDKReady = () => {
      if (!accessToken) return;
      initializeSpotifyPlayer();
    };

    function initializeSpotifyPlayer() {
      spotifyPlayer = new Spotify.Player({
        name: 'Spotify QR Scanner',
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.5
      });

      spotifyPlayer.addListener('initialization_error', ({ message }) => {
        console.error(`Initialization Error: ${message}`);
      });
      spotifyPlayer.addListener('authentication_error', ({ message }) => {
        console.error(`Authentication Error: ${message}`);
      });
      spotifyPlayer.addListener('account_error', ({ message }) => {
        console.error(`Account Error: ${message}`);
      });
      spotifyPlayer.addListener('playback_error', ({ message }) => {
        console.error(`Playback Error: ${message}`);
      });
      spotifyPlayer.addListener('player_state_changed', state => {
        if (state) {
          isPlaying = !state.paused;
          updatePlayPauseButton();
          if (state.track_window && state.track_window.current_track) {
            currentTrackName = state.track_window.current_track.name;
          }
          if (isPlaying && (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive')) {
            startPositionCheck();
          } else if (!isPlaying) {
            clearPositionCheckInterval();
          }
        }
      });
      spotifyPlayer.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        playerReady = true;
        if (currentTrackUri && !gameModeSwitched) {
          startPlayback(currentTrackUri);
        }
        if (gameModeSwitched) { gameModeSwitched = false; }
      });
      spotifyPlayer.addListener('not_ready', ({ device_id }) => {
        playerReady = false;
      });
      spotifyPlayer.connect().then(success => {
        if (!success) { console.error('Spotify Player Connection Failed'); }
      }).catch(error => {
        console.error(`Connection Error: ${error}`);
      });
    }

    function startPositionCheck() {
      clearPositionCheckInterval();
      positionCheckInterval = setInterval(async () => {
        try {
          if (!spotifyPlayer) { clearPositionCheckInterval(); return; }
          const state = await spotifyPlayer.getCurrentState();
          if (!state) return;
          if (state.position >= randomSegmentEnd) {
            spotifyPlayer.pause();
            isPlaying = false;
            updatePlayPauseButton();
            clearPositionCheckInterval();
          }
        } catch (error) {
          console.error(`Position check error: ${error}`);
        }
      }, 500);
    }

    function clearPositionCheckInterval() {
      if (positionCheckInterval) { clearInterval(positionCheckInterval); positionCheckInterval = null; }
    }

    function updatePlayPauseButton() {
      playPauseBtn.textContent = isPlaying ? '⏸️' : '▶️';
    }

    function initiateSpotifyLogin() {
      const authUrl = new URL('https://accounts.spotify.com/authorize');
      authUrl.searchParams.set('client_id', CLIENT_ID);
      authUrl.searchParams.set('response_type', 'token');
      authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
      authUrl.searchParams.set('scope', SCOPES);
      authUrl.searchParams.set('show_dialog', 'true');
      window.location.href = authUrl.toString();
    }

    function switchToScreen(screenElement) {
      [loginScreen, scannerScreen, playlistInputScreen, playerScreen].forEach(screen => {
        screen.style.display = 'none';
      });
      screenElement.style.display = 'flex';
      if (screenElement !== playerScreen) { clearPositionCheckInterval(); }
    }

    function startQRScanner() {
      if (scannerInitialized) { switchToScreen(scannerScreen); return; }
      if (scannerStopping) { setTimeout(startQRScanner, 500); return; }
      switchToScreen(scannerScreen);
      readerElement.innerHTML = '';
      statusElement.textContent = "Initializing camera...";
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const backCamera = cameras.find(camera => camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('environment'));
          const cameraToUse = backCamera ? backCamera.id : cameras[0].id;
          html5QrCode.start(cameraToUse, { fps: 10, qrbox: Math.min(readerElement.clientWidth * 0.9, 350) },
            onScanSuccess,
            (error) => { if (error !== "QR code parse error, error = QR code not found.") { console.error(`QR Scanner Error: ${error}`); } }
          ).then(() => {
            scannerInitialized = true;
            statusElement.textContent = "Ready to scan Spotify code";
          }).catch(err => {
            console.error(`Camera Start Error: ${err}`);
            statusElement.textContent = "Camera error. Please try again.";
            scannerInitialized = false;
            setTimeout(startQRScanner, 1000);
          });
        } else {
          statusElement.textContent = "No cameras found";
          console.error('No cameras found');
          scannerInitialized = false;
        }
      }).catch(error => {
        statusElement.textContent = "Camera access error";
        console.error(`Camera Detection Error: ${error}`);
        scannerInitialized = false;
      });
    }

    async function stopQRScanner() {
      if (!html5QrCode || !scannerInitialized) return Promise.resolve();
      scannerStopping = true;
      try {
        await html5QrCode.stop();
        console.log("QR Scanner stopped successfully");
      } catch (err) {
        console.error(`Error stopping QR scanner: ${err}`);
      } finally {
        scannerInitialized = false;
        scannerStopping = false;
        html5QrCode = null;
      }
    }

    function onScanSuccess(decodedText) {
      const trackIdMatch = decodedText.match(/spotify:track:([a-zA-Z0-9]+)/) ||
                           decodedText.match(/open\.spotify\.com\/track\/([a-zA-Z0-9]+)/);
      if (trackIdMatch) {
        const trackId = trackIdMatch[1];
        currentTrackUri = `spotify:track:${trackId}`;
        stopQRScanner().then(() => {
          if (playerReady) { startPlayback(currentTrackUri); }
          switchToScreen(playerScreen);
        });
      }
    }

    // The original startPlayback from your pre_playlist file
    async function startPlayback(trackUri) {
      try {
        if (!deviceId) {
          console.error('No device ID available yet');
          return;
        }
        // Fetch track details
        const trackResponse = await fetch(`https://api.spotify.com/v1/tracks/${trackUri.split(':')[2]}`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!trackResponse.ok) {
          console.error(`Error getting track: ${trackResponse.status}`);
          return;
        }
        const trackData = await trackResponse.json();
        trackDuration = trackData.duration_ms;
        currentTrackName = trackData.name;
        // Set snippet options based on mode
        if (gameModeSelect.value === 'random10') {
          const maxStartTime = Math.max(0, trackDuration - 10000);
          randomSegmentStart = Math.floor(Math.random() * maxStartTime);
          randomSegmentEnd = randomSegmentStart + 10000;
        } else if (gameModeSelect.value === 'progressive') {
          currentDurationIndex = 0;
          const maxStartTime = Math.max(0, trackDuration - progressiveDurations[progressiveDurations.length - 1]);
          randomSegmentStart = Math.floor(Math.random() * maxStartTime);
          randomSegmentEnd = randomSegmentStart + progressiveDurations[currentDurationIndex];
          snippetDurationElement.style.display = 'block';
          increaseDurationBtn.style.display = 'flex';
          updateProgressiveMode();
        } else {
          snippetDurationElement.style.display = 'none';
          increaseDurationBtn.style.display = 'none';
        }
        // Transfer playback to our device (without starting yet)
        await fetch('https://api.spotify.com/v1/me/player', {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ device_ids: [deviceId], play: false })
        });
        await new Promise(resolve => setTimeout(resolve, 500));
        // Start playback
        const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uris: [trackUri],
            position_ms: (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive') ? randomSegmentStart : 0
          })
        });
        if (!response.ok && response.status !== 204) {
          try { spotifyPlayer.resume(); } catch (e) { console.error(`Playback Error: ${e}`); }
        } else {
          isPlaying = true;
          updatePlayPauseButton();
          if (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive') { startPositionCheck(); }
        }
      } catch (error) {
        console.error(`Playback Error: ${error}`);
        try {
          await fetch(`https://api.spotify.com/v1/me/player/play`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
              uris: [trackUri],
              position_ms: (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive') ? randomSegmentStart : 0
            })
          });
        } catch (fallbackError) {
          console.error(`Fallback playback error: ${fallbackError}`);
        }
      }
    }

    function increaseDuration() {
      if (currentDurationIndex < progressiveDurations.length - 1) {
        currentDurationIndex++;
        updateProgressiveMode();
      }
    }

    function updateProgressiveMode() {
      const duration = progressiveDurations[currentDurationIndex];
      randomSegmentEnd = randomSegmentStart + duration;
      snippetDurationElement.textContent = `Current snippet: ${duration / 1000} seconds`;
      if (isPlaying) {
        spotifyPlayer.pause().then(() => {
          setTimeout(() => {
            spotifyPlayer.seek(randomSegmentStart).then(() => {
              spotifyPlayer.resume().then(() => { startPositionCheck(); });
            });
          }, 300);
        });
      }
    }

    async function togglePlayPause() {
      if (!spotifyPlayer) return;
      try {
        if (isPlaying) {
          await spotifyPlayer.pause();
          clearPositionCheckInterval();
        } else {
          if (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive') {
            await spotifyPlayer.seek(randomSegmentStart);
          }
          await spotifyPlayer.resume();
          if (gameModeSelect.value === 'random10' || gameModeSelect.value === 'progressive') {
            startPositionCheck();
          }
        }
      } catch (error) {
        console.error(`Toggle play/pause error: ${error}`);
      }
    }

    async function seekForward() {
      if (!spotifyPlayer) return;
      try {
        const state = await spotifyPlayer.getCurrentState();
        if (!state) return;
        const currentPosition = state.position;
        if (gameModeSelect.value === 'progressive') {
          const newPosition = Math.min(randomSegmentEnd, currentPosition + 10000);
          await spotifyPlayer.seek(newPosition);
          if (!isPlaying) {
            await spotifyPlayer.resume();
            isPlaying = true;
            updatePlayPauseButton();
            startPositionCheck();
          }
          return;
        } else if (gameModeSelect.value === 'random10') {
          await spotifyPlayer.seek(randomSegmentStart);
          if (!isPlaying) {
            await spotifyPlayer.resume();
            isPlaying = true;
            updatePlayPauseButton();
            startPositionCheck();
          }
          return;
        }
        const newPosition = Math.min(trackDuration, currentPosition + 10000);
        await spotifyPlayer.seek(newPosition);
      } catch (error) {
        console.error(`Seek error: ${error}`);
      }
    }

    // --- Playlist Mode Functions ---
    function getPlaylistIdFromUrl(url) {
      const regex = /(?:playlist\/|spotify:playlist:)([a-zA-Z0-9]+)/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    async function fetchPlaylistTracks(playlistId) {
      try {
        let allTracks = [];
        let offset = 0, limit = 100;
        let response;
        do {
          response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=${limit}&offset=${offset}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          if (!response.ok) {
            console.error(`Error fetching playlist: ${response.status}`);
            break;
          }
          const data = await response.json();
          const tracks = data.items
            .filter(item => item.track && !item.track.is_local)
            .map(item => item.track.uri);
          allTracks = allTracks.concat(tracks);
          offset += tracks.length;
        } while (response && offset < response.total);
        return allTracks;
      } catch (error) {
        console.error(error);
        return [];
      }
    }

    function getRandomTrackFromPlaylist() {
      if (playlistTracks.length === 0) return null;
      const randomIndex = Math.floor(Math.random() * playlistTracks.length);
      return playlistTracks[randomIndex];
    }

    async function playRandomPlaylistTrack() {
      const trackUri = getRandomTrackFromPlaylist();
      if (!trackUri) {
        console.error("No track found in playlist.");
        return;
      }
      currentTrackUri = trackUri;
      await startPlayback(currentTrackUri);
    }

    // --- Event Listeners ---
    spotifyLoginBtn.addEventListener('click', initiateSpotifyLogin);
    playPauseBtn.addEventListener('click', togglePlayPause);
    seekForwardBtn.addEventListener('click', seekForward);
    returnToScannerBtn.addEventListener('click', async () => {
      if (spotifyPlayer && isPlaying) {
        try { await spotifyPlayer.pause(); } catch (err) { console.error(`Error pausing player: ${err}`); }
        isPlaying = false;
      }
      clearPositionCheckInterval();
      await stopQRScanner();
      setTimeout(startQRScanner, 500);
      isPlaylistMode = false;
    });

    gameModeSelect.addEventListener('change', () => { gameModeSwitched = true; });

    // Playlist Mode button: switch to playlist input screen
    switchToPlaylistBtn.addEventListener('click', () => { switchToScreen(playlistInputScreen); });
    backToScannerBtn.addEventListener('click', () => { switchToScreen(scannerScreen); startQRScanner(); });

    startPlaylistBtn.addEventListener('click', async () => {
      const playlistUrl = playlistUrlInput.value.trim();
      const playlistId = getPlaylistIdFromUrl(playlistUrl);
      if (!playlistId) {
        alert("Please enter a valid Spotify playlist URL");
        return;
      }
      playlistTracks = await fetchPlaylistTracks(playlistId);
      if (playlistTracks.length === 0) {
        alert("Could not load tracks from this playlist. Please check the URL and try again.");
        return;
      }
      isPlaylistMode = true;
      switchToScreen(playerScreen);
      playRandomPlaylistTrack();
    });

    // --- Initialization ---
    function init() {
      const hash = window.location.hash.substring(1).split('&').reduce((initial, item) => {
        if (item) {
          const parts = item.split('=');
          initial[parts[0]] = decodeURIComponent(parts[1]);
        }
        return initial;
      }, {});
      if (hash.access_token) {
        accessToken = hash.access_token;
        window.location.hash = '';
        if (window.Spotify) { initializeSpotifyPlayer(); }
        startQRScanner();
      } else {
        switchToScreen(loginScreen);
      }
    }

    window.addEventListener('beforeunload', () => {
      clearPositionCheckInterval();
      stopQRScanner();
    });

    init();
  </script>
</body>
</html>
