<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mystery Spotify Scanner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: linear-gradient(135deg, #1DB954 0%, #191414 100%);
      color: white;
    }
    
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .btn {
      background-color: white;
      color: #191414;
      border: none;
      border-radius: 2rem;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      margin: 0.5rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    
    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    
    .scanner-container {
      width: 100%;
      max-width: 300px;
      height: 300px;
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      margin: 1rem 0;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      display: none;
    }
    
    #scanner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 2px solid white;
      border-radius: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1rem;
    }
    
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background-color: #1DB954;
      top: 50%;
      left: 0;
      box-shadow: 0 0 8px 2px #1DB954;
      animation: scan 2s linear infinite;
    }
    
    @keyframes scan {
      0% {
        top: 20%;
      }
      50% {
        top: 80%;
      }
      100% {
        top: 20%;
      }
    }
    
    .status {
      font-size: 0.9rem;
      margin-top: 1rem;
      opacity: 0.8;
    }
    
    .playing-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      margin-top: 1rem;
    }
    
    .playing-indicator .bar {
      display: inline-block;
      width: 4px;
      height: 20px;
      margin: 0 2px;
      background-color: white;
      border-radius: 2px;
      animation: sound 0ms -800ms linear infinite alternate;
    }
    
    .playing-indicator .bar:nth-child(1) { animation-duration: 474ms; }
    .playing-indicator .bar:nth-child(2) { animation-duration: 433ms; }
    .playing-indicator .bar:nth-child(3) { animation-duration: 407ms; }
    .playing-indicator .bar:nth-child(4) { animation-duration: 458ms; }
    .playing-indicator .bar:nth-child(5) { animation-duration: 400ms; }
    
    @keyframes sound {
      0% {
        opacity: 0.35;
        height: 5px;
      }
      100% {
        opacity: 1;
        height: 28px;
      }
    }
    
    .form-group {
      margin: 1rem 0;
      width: 100%;
      max-width: 300px;
    }
    
    .form-input {
      width: 100%;
      padding: 0.8rem;
      border-radius: 1rem;
      border: none;
      font-size: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 1rem;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .tab {
      flex: 1;
      padding: 0.8rem;
      background-color: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tab.active {
      background-color: rgba(255,255,255,0.2);
    }
    
    .tab-content {
      display: none;
      width: 100%;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mystery Spotify Scanner</h1>
    <p>Play Spotify tracks without seeing what they are</p>
    
    <div class="tab-container">
      <button class="tab active" id="cameraTab">Scan QR Code</button>
      <button class="tab" id="linkTab">Enter Link</button>
    </div>
    
    <div class="tab-content active" id="cameraContent">
      <button id="startButton" class="btn">Start Scanning</button>
      
      <div class="scanner-container" id="scannerContainer">
        <video id="scanner" autoplay playsinline></video>
        <div class="scanner-overlay">
          <div class="scan-line"></div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="linkContent">
      <div class="form-group">
        <input type="text" id="spotifyLink" class="form-input" placeholder="Paste Spotify link here" />
      </div>
      <button id="playButton" class="btn">Play Mystery Track</button>
    </div>
    
    <div class="status" id="status">Ready to play</div>
    
    <div class="playing-indicator" id="playingIndicator">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Check camera permission status
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name: 'camera'}).then(result => {
          if (result.state === 'denied') {
            status.textContent = 'Please enable camera access in your browser settings';
          }
        }).catch(err => {
          console.log('Permissions API not supported');
        });
      }
    });
    
    const startButton = document.getElementById('startButton');
    const playButton = document.getElementById('playButton');
    const scannerContainer = document.getElementById('scannerContainer');
    const scanner = document.getElementById('scanner');
    const status = document.getElementById('status');
    const playingIndicator = document.getElementById('playingIndicator');
    const spotifyLink = document.getElementById('spotifyLink');
    const cameraTab = document.getElementById('cameraTab');
    const linkTab = document.getElementById('linkTab');
    const cameraContent = document.getElementById('cameraContent');
    const linkContent = document.getElementById('linkContent');
    
    let scanning = false;
    
    // Tab switching
    cameraTab.addEventListener('click', () => {
      cameraTab.classList.add('active');
      linkTab.classList.remove('active');
      cameraContent.classList.add('active');
      linkContent.classList.remove('active');
      stopScanning();
    });
    
    linkTab.addEventListener('click', () => {
      linkTab.classList.add('active');
      cameraTab.classList.remove('active');
      linkContent.classList.add('active');
      cameraContent.classList.remove('active');
      stopScanning();
    });
    
    // Camera scanning
    startButton.addEventListener('click', () => {
      if (scanning) {
        stopScanning();
        startButton.textContent = 'Start Scanning';
        status.textContent = 'Ready to scan';
      } else {
        startScanning();
        startButton.textContent = 'Stop Scanning';
        status.textContent = 'Scanning... Point camera at a Spotify code or QR code';
      }
    });
    
    // Link entry
    playButton.addEventListener('click', () => {
      const link = spotifyLink.value.trim();
      if (link) {
        processSpotifyLink(link);
        spotifyLink.value = '';
      } else {
        status.textContent = 'Please enter a Spotify link';
      }
    });
    
    // Start camera scanning
    function startScanning() {
      scanning = true;
      scannerContainer.style.display = 'block';
      
      // Access the device camera
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
      .then(stream => {
        scanner.srcObject = stream;
        scanner.play();
        requestAnimationFrame(tick);
      })
      .catch(error => {
        status.textContent = 'Camera access error: ' + error.message;
        console.error('Camera error:', error);
        scanning = false;
        startButton.textContent = 'Try Again';
      });
    }
    
    // Stop camera scanning
    function stopScanning() {
      scanning = false;
      scannerContainer.style.display = 'none';
      
      if (scanner.srcObject) {
        const tracks = scanner.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        scanner.srcObject = null;
      }
    }
    
    // Process camera frames looking for QR codes
    function tick() {
      if (!scanning) return;
      
      if (scanner.readyState === scanner.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = scanner.videoWidth;
        canvas.height = scanner.videoHeight;
        context.drawImage(scanner, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          const url = code.data;
          
          // Check if it's a potentially valid URL
          if (url.includes('http') || url.includes('spotify:')) {
            processSpotifyLink(url);
          }
        }
      }
      
      requestAnimationFrame(tick);
    }
    
    // Handle Spotify links (from QR or manual entry)
    function processSpotifyLink(url) {
      // First check if we can extract a Spotify URI or URL
      let spotifyUri = '';
      
      // Case 1: Direct spotify: URI
      if (url.startsWith('spotify:')) {
        spotifyUri = url;
      } 
      // Case 2: Standard Spotify URL
      else if (url.includes('open.spotify.com')) {
        // Regular Spotify URL - we'll just use as is
        spotifyUri = url;
      }
      // Case 3: Try to find any URL in the scanned text
      else if (url.includes('http')) {
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        const matches = url.match(urlPattern);
        if (matches && matches.length > 0) {
          spotifyUri = matches[0];
        }
      }
      
      // If we found a potentially valid URL/URI
      if (spotifyUri) {
        // Play the track
        playTrack(spotifyUri);
        
        // Update status and visuals
        status.textContent = 'Now playing mystery track';
        playingIndicator.style.display = 'flex';
        
        // Stop scanning if that's how we got here
        if (scanning) {
          stopScanning();
          startButton.textContent = 'Scan Another';
        }
      } else {
        status.textContent = 'Not a valid Spotify link';
      }
    }
    
    // Open track in Spotify
    function playTrack(uri) {
      console.log('Playing:', uri);
      
      // First try to open in Spotify app
      window.location.href = uri.startsWith('spotify:') ? uri : `spotify:track:${getSpotifyId(uri)}`;
      
      // If we're still here after a delay, try regular URL opening
      setTimeout(() => {
        if (!uri.startsWith('http')) {
          window.location.href = `https://open.spotify.com/track/${getSpotifyId(uri)}`;
        }
      }, 1000);
    }
    
    // Extract Spotify ID from various formats
    function getSpotifyId(uri) {
      if (uri.startsWith('spotify:')) {
        const parts = uri.split(':');
        return parts[parts.length - 1];
      } else if (uri.includes('open.spotify.com')) {
        const parts = uri.split('/');
        return parts[parts.length - 1].split('?')[0];
      }
      return uri; // If we can't parse it, just return as is
    }
  </script>
</body>
</html>
