<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify QR Scanner + PDF Generator (with Square Overlay)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>
  <canvas id="text-canvas" style="display:none;"></canvas>

  <script>
    async function generatePDFfromPlaylist() {
      if (!accessToken) {
        alert('Please log in with Spotify first.');
        return;
      }
      const playlistUrl = prompt('Enter a Spotify Playlist URL:');
      if (!playlistUrl) return;

      const playlistId = getPlaylistIdFromUrl(playlistUrl.trim());
      if (!playlistId) {
        alert('Invalid Spotify playlist URL.');
        return;
      }

      const loaderBtn = document.activeElement;
      loaderBtn.textContent = 'Loadingâ€¦';
      loaderBtn.disabled = true;

      const tracks = await fetchPlaylistTracks(playlistId);
      if (!tracks.length) {
        alert('Could not load tracks or playlist is empty.');
        loaderBtn.textContent = 'Generate PDF from Playlist';
        loaderBtn.disabled = false;
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      const cols = 3;
      const rows = 4;
      const cellWidth = (pageWidth - 2 * margin) / cols;
      const cellHeight = (pageHeight - 2 * margin) / rows;
      const fontSize = 12;
      const lineHeight = fontSize * 1.2;

      const canvas = document.getElementById('text-canvas');
      canvas.width = Math.ceil(cellWidth);
      canvas.height = Math.ceil(cellHeight);
      const ctx = canvas.getContext('2d');

      function wrapText(text, maxWidthPx) {
        const words = text.split(' ');
        const lines = [];
        let current = '';
        ctx.font = `${fontSize}pt Arial`;
        for (let w of words) {
          const test = current ? (current + ' ' + w) : w;
          const testWidth = ctx.measureText(test).width;
          if (testWidth <= maxWidthPx) {
            current = test;
          } else {
            if (current) lines.push(current);
            current = w;
          }
        }
        if (current) lines.push(current);
        return lines;
      }

      for (let i = 0; i < tracks.length; i += 12) {
        const group = tracks.slice(i, i + 12);

        // QR Code Page
        group.forEach((track, idx) => {
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x = margin + col * cellWidth;
          const y = margin + row * cellHeight;

          const qr = new QRious({ value: track.external_url, size: Math.floor(cellWidth * 0.8) });
          doc.addImage(
            qr.toDataURL("image/png"),
            "PNG",
            x + cellWidth * 0.1,
            y + cellHeight * 0.1,
            cellWidth * 0.8,
            cellHeight * 0.8
          );
        });
        doc.addPage();

        // Info Page (Mirrored)
        for (let idx = 0; idx < group.length; idx++) {
          const track = group[idx];
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const x0 = margin + col * cellWidth;
          const y0 = margin + row * cellHeight;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const labelSong = 'ðŸŽµ ';
          const labelArtist = 'ðŸ‘¤ ';
          const labelAlbum = 'ðŸ’¿ ';
          const labelYear = 'ðŸ“… ';
          const maxTextWidthPx = cellWidth - 16;

          ctx.fillStyle = "#000000";
          ctx.textAlign = "center";
          ctx.textBaseline = "top";

          const year = track.release_date ? track.release_date.split('-')[0] : 'N/A';
          let lines = [];
          lines.push(...wrapText(labelSong + track.name, maxTextWidthPx));
          lines.push(...wrapText(labelArtist + track.artists, maxTextWidthPx));
          lines.push(...wrapText(labelAlbum + track.album, maxTextWidthPx));
          lines.push(...wrapText(labelYear + year, maxTextWidthPx));

          const totalTextHeightPx = lines.length * lineHeight;
          const startY = (canvas.height - totalTextHeightPx) / 2;

          for (let j = 0; j < lines.length; j++) {
            ctx.font = lines[j].startsWith('ðŸ“…') ? `${fontSize + 2}pt Arial` : `${fontSize}pt Arial`;
            ctx.fillText(lines[j], canvas.width / 2, startY + j * lineHeight);
          }

          const img = new Image();
          img.src = canvas.toDataURL("image/png");
          await new Promise((res) => {
            img.onload = () => {
              const mirrorCanvas = document.createElement("canvas");
              mirrorCanvas.width = canvas.width;
              mirrorCanvas.height = canvas.height;
              const mCtx = mirrorCanvas.getContext("2d");
              mCtx.translate(mirrorCanvas.width, 0);
              mCtx.scale(-1, 1);
              mCtx.drawImage(img, 0, 0);
              const mirroredData = mirrorCanvas.toDataURL("image/png");
              doc.addImage(mirroredData, "PNG", x0, y0, cellWidth, cellHeight);
              res();
            };
          });
        }

        if (i + 12 < tracks.length) doc.addPage();
      }

      doc.save("playlist-12-grid.pdf");
      loaderBtn.textContent = 'Generate PDF from Playlist';
      loaderBtn.disabled = false;
    }

    generatePdfScannerBtn.addEventListener('click', generatePDFfromPlaylist);
  </script>
</body>
</html>
